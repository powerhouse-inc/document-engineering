import { Meta, Source, Canvas, Controls } from '@storybook/blocks'

<Meta title="Data Display/Object Set Table/Docs/Events" />

## Events

The Table dispatches DOM events for all operations. Events are type-safe and include detailed context.

### Available Events

#### Editing Events

| Event                                 | When                  | Key Payload Fields                    |
| ------------------------------------- | --------------------- | ------------------------------------- |
| `table:editing:start`                 | Cell enters edit mode | `currentValue`, `isAddingRow`         |
| `table:editing:save`                  | Cell edit saved       | `oldValue`, `newValue`, `isAddingRow` |
| `table:editing:exit`                  | Exit edit mode        | `saved` (boolean), `finalValue`       |
| `table:editing:validationError`       | Validation fails      | `errors[]`, `value`                   |
| `table:editing:validationSuccess`     | Validation passes     | `value`                               |
| `table:editing:validationErrorChange` | Error state changes   | `previousErrors[]`, `currentErrors[]` |

#### Insert Events

| Event                  | When                              | Key Payload Fields                                         |
| ---------------------- | --------------------------------- | ---------------------------------------------------------- |
| `table:insert:start`   | User starts editing insertion row | `field`, `currentRowCount`                                 |
| `table:insert:success` | New row insertion completed       | `insertedData`, `field`, `newRowCount`, `insertedRowIndex` |
| `table:insert:cancel`  | Insertion cancelled               | `field`, `cancelledValue`, `reason`                        |

#### Delete Events

| Event                  | When                            | Key Payload Fields                                               |
| ---------------------- | ------------------------------- | ---------------------------------------------------------------- |
| `table:delete:start`   | Delete operation begins         | `rowIndexes[]`, `rowsData[]`, `rowCount`, `requiresConfirmation` |
| `table:delete:confirm` | User confirms deletion          | `rowIndexes[]`, `rowsData[]`, `rowCount`, `confirmationDetails`  |
| `table:delete:success` | Deletion completed successfully | `rowIndexes[]`, `rowsData[]`, `rowCount`, `remainingRowCount`    |
| `table:delete:cancel`  | Deletion cancelled              | `rowIndexes[]`, `rowsData[]`, `rowCount`, `reason`               |
| `table:delete:error`   | Deletion failed                 | `rowIndexes[]`, `rowsData[]`, `rowCount`, `error`                |

#### Sort Events

| Event               | When                          | Key Payload Fields                                                                                               |
| ------------------- | ----------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| `table:sort:change` | Column sort direction changes | `columnIndex`, `columnDef`, `previousDirection`, `newDirection`, `previousColumnIndex`, `sortState`, `dataCount` |
| `table:sort:clear`  | Column sorting is cleared     | `columnIndex`, `columnDef`, `previousSortState`, `dataCount`                                                     |

**Common Payload Fields:**

_Editing Events:_

- `timestamp: Date` - When event occurred
- `rowIndex: number` - Row position (0-based)
- `cell: { row, column }` - Cell coordinates
- `columnDef: ColumnDef<TData>` - Column configuration
- `rowData?: TData` - Complete row data (optional)

_Insert Events:_

- `timestamp: Date` - When event occurred
- `field: string` - Field being edited/inserted
- `cell: { row, column }` - Cell coordinates (insertion row)
- `columnDef: ColumnDef<TData>` - Column configuration
- `rowData?: TData` - Row data (undefined for insertion row)

_Delete Events:_

- `timestamp: Date` - When event occurred
- `rowIndexes: number[]` - Array of row positions being deleted
- `rowsData: TData[]` - Array of complete row data being deleted
- `rowCount: number` - Number of rows being deleted

_Sort Events:_

- `timestamp: Date` - When event occurred
- `columnIndex: number` - Column position (0-based)
- `columnDef: ColumnDef<TData>` - Column configuration
- `dataCount: number` - Total number of rows in the table

---

## Usage

### Basic Setup

```tsx
import { useEffect, useRef } from 'react'
import type { TableApiBase, TableEventMap } from '@powerhousedao/document-engineering'

const MyComponent = () => {
  const apiRef = useRef<TableApiBase<MyDataType>>(null)

  useEffect(() => {
    const tableElement = apiRef.current?.getHTMLTable()
    if (!tableElement) return

    const handleSave = ((event: CustomEvent<TableEventMap<MyDataType>['table:editing:save']>) => {
      const { columnDef, oldValue, newValue } = event.detail
      console.log(`${columnDef.field}: ${oldValue} â†’ ${newValue}`)
    }) as EventListener

    tableElement.addEventListener('table:editing:save', handleSave)
    return () => tableElement.removeEventListener('table:editing:save', handleSave)
  }, [])

  return <ObjectSetTable data={data} columns={columns} apiRef={apiRef} />
}
```

### Multiple Events

```tsx
useEffect(() => {
  const tableElement = apiRef.current?.getHTMLTable()
  if (!tableElement) return

  const handlers = {
    'table:editing:start': (e: CustomEvent) => {
      const { columnDef, isAddingRow } = e.detail
      setEditingState({ field: columnDef.field, isNew: isAddingRow })
    },
    'table:editing:save': (e: CustomEvent) => {
      const { columnDef, newValue } = e.detail
      syncToAPI(columnDef.field, newValue)
    },
    'table:editing:validationError': (e: CustomEvent) => {
      const { cell, errors } = e.detail
      showErrors(`${cell.row}-${cell.column}`, errors)
    },
    'table:insert:start': (e: CustomEvent) => {
      const { field, currentRowCount } = e.detail
      console.log(`Starting to add new row via ${field} field (${currentRowCount} rows currently)`)
    },
    'table:insert:success': (e: CustomEvent) => {
      const { insertedData, field, newRowCount } = e.detail
      console.log(`New row added via ${field}:`, insertedData, `(${newRowCount} rows total)`)
    },
    'table:insert:cancel': (e: CustomEvent) => {
      const { field, reason } = e.detail
      console.log(`Insertion cancelled for ${field}: ${reason}`)
    },
  } as const

  // Register all
  Object.entries(handlers).forEach(([event, handler]) => {
    tableElement.addEventListener(event, handler as EventListener)
  })

  // Cleanup all
  return () => {
    Object.entries(handlers).forEach(([event, handler]) => {
      tableElement.removeEventListener(event, handler as EventListener)
    })
  }
}, [])
```

---

## Related Docs

- [API Reference](?path=/docs/data-display-object-set-table-docs-api--readme): Full API documentation
- [Editing](?path=/docs/data-display-object-set-table-docs-editing--readme): Cell editing and validation
- [Events Example](?path=/story/data-display-object-set-table-examples-events--default): Live event logging demo
